---
import Section from "./Section.astro";

const roles = [
    {
        title: "Applied ML Engineer",
        description:
            "Bridging the gap between research and production systems.",
        skills: [
            "PyTorch",
            "TRT-LLM",
            "Docker",
            "FastAPI",
            "Kubernetes",
            "Redis",
        ],
        isPrimary: true,
    },
    {
        title: "MLOps Architect",
        description:
            "Designing scalable infrastructure for automated model lifecycles.",
        skills: [
            "Airflow",
            "MLflow",
            "KubeFlow",
            "Terraform",
            "AWS",
            "Prometheus",
        ],
    },
    {
        title: "Backend Engineer",
        description:
            "Building the backbone for performance-critical applications.",
        skills: ["Go", "Rust", "TypeScript", "PostgreSQL", "gRPC", "Kafka"],
    },
    {
        title: "AI Product Designer",
        description:
            "Ensuring human-centered design in the age of intelligence.",
        skills: [
            "Next.js",
            "Tailwind",
            "Framer Motion",
            "D3.js",
            "User Research",
        ],
    },
];
---

<Section id="roles" class="py-24">
    <div class="max-w-7xl mx-auto px-8">
        <!-- Stacked layout for better carousel interaction -->
        <div class="space-y-12">
            <!-- Stack Display on the Left -->
            <div
                class="glass-card p-6 lg:p-8 bg-accent-primary/5 border-accent-primary/20 w-fit"
            >
                <p
                    class="text-sm font-mono text-accent-primary mb-2 uppercase tracking-widest"
                >
                    Stack for this role:
                </p>
                <div
                    id="typewriter-container"
                    class="font-display text-xl lg:text-2xl font-bold text-text-primary typewriter-cursor"
                >
                </div>
            </div>

            <!-- Horizontal Carousel -->
            <div class="relative -mx-10">
                <div
                    id="roles-carousel"
                    class="flex gap-6 overflow-x-auto pb-8 pt-4 px-10 snap-x snap-mandatory scrollbar-hide no-scrollbar scroll-smooth"
                >
                    {
                        roles.map((role, index) => (
                            <div
                                class="role-card flex-none w-[280px] sm:w-[320px] lg:w-[380px] snap-start glass-card p-10 cursor-pointer group/card transition-all duration-500 relative"
                                data-index={index}
                                data-skills={role.skills.join(", ")}
                                tabindex="0"
                                role="button"
                                aria-label={`Select ${role.title}`}
                            >
                                {role.isPrimary && (
                                    <div class="absolute -top-3 -right-3 bg-accent-primary text-bg-primary text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest shadow-[0_0_15px_rgba(var(--color-accent-primary),0.6)] z-20">
                                        Primary Focus
                                    </div>
                                )}
                                <h3 class="font-display text-2xl font-bold mb-4 transition-colors duration-300 group-[.active]:text-accent-primary">
                                    {role.title}
                                </h3>
                                <p class="text-text-secondary leading-relaxed">
                                    {role.description}
                                </p>

                                <div class="mt-8 flex justify-end">
                                    <span class="w-12 h-px bg-white/10 group-[.active]:bg-accent-primary group-[.active]:w-full transition-all duration-500" />
                                </div>
                            </div>
                        ))
                    }
                    <!-- Back to Start Button -->
                    <button
                        id="back-to-start"
                        class="flex-none w-[200px] snap-start glass-card p-10 cursor-pointer flex flex-col items-center justify-center gap-4 transition-all duration-300 hover:border-accent-primary/50 hover:bg-accent-primary/5 group"
                        aria-label="Back to start"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-text-secondary group-hover:text-accent-primary transition-colors"
                        >
                            <path d="m12 19-7-7 7-7"></path>
                            <path d="M19 12H5"></path>
                        </svg>
                        <span
                            class="font-display text-sm font-semibold text-text-secondary group-hover:text-accent-primary transition-colors"
                        >
                            Back to Start
                        </span>
                    </button>
                    <!-- Spacer sized to allow last card to reach leftmost -->
                    <div
                        class="flex-none w-[calc(100vw-380px-200px-4rem)] lg:w-[calc(100vw-380px-200px-6rem)] pointer-events-none"
                    >
                    </div>
                </div>

                <!-- Indicators -->
                <div class="flex gap-2 mt-4 justify-start px-8">
                    {
                        roles.map((role, i) => (
                            <div
                                class="h-2 w-8 bg-white/10 rounded-full indicator cursor-pointer overflow-hidden transition-all duration-300"
                                data-index={i}
                                tabindex="0"
                                role="button"
                                aria-label={`Go to ${role.title}`}
                            >
                                <div class="indicator-fill h-full w-0 bg-accent-primary" />
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</Section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("[RolesCarousel] Initializing...");

        var carousel = document.getElementById("roles-carousel");
        var typewriterElement = document.getElementById("typewriter-container");
        var cards = document.querySelectorAll(".role-card");
        var indicators = document.querySelectorAll(".indicator");

        console.log("[RolesCarousel] Found elements:", {
            carousel: !!carousel,
            typewriter: !!typewriterElement,
            cards: cards.length,
            indicators: indicators.length,
        });

        var activeIndex = -1;

        // --- Active Card Detection ---
        function updateActiveFromScroll() {
            if (!carousel) return;

            var closestIndex = 0;
            var minDistance = Infinity;

            for (var i = 0; i < cards.length; i++) {
                var card = cards[i] as HTMLElement;
                var rect = card.getBoundingClientRect();
                var carouselRect = carousel.getBoundingClientRect();
                var distance = Math.abs(rect.left - carouselRect.left);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            }

            if (closestIndex !== activeIndex) {
                setActiveCard(closestIndex);
            }
        }

        function setActiveCard(index: number) {
            // Allow resetting the same index if we want to restart the animation manually
            // But existing logic blocks it.
            // If we want clicking the indicator to "restart" the timer for that slide, we need to allow re-entry or force reflow explicitly.
            if (index === activeIndex) {
                // Determine if we need to force restart current animation
                // For now, if activeIndex matches, we just insure animation is running?
                // Actually, if we click the current one, updateActiveFromScroll calls us.
                // Let's rely on the indicators loop below to handle reflows if needed,
                // but usually we exit early here.
                // If the user clicks the *current* card, we probably want to restart the timer.
                // So let's allow it?
                // Problem: Scroll event fires constantly. We don't want to restart constantly.
                // So we MUST return if index === activeIndex.
                return;
            }

            activeIndex = index;
            console.log("[RolesCarousel] Setting active card:", index);

            // Update card styles
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                if (i === activeIndex) {
                    card.classList.add(
                        "active",
                        "border-accent-primary/50",
                        "bg-accent-primary/5",
                    );
                    card.classList.remove("opacity-20", "scale-95");
                } else {
                    card.classList.remove(
                        "active",
                        "border-accent-primary/50",
                        "bg-accent-primary/5",
                    );
                    card.classList.add("opacity-20", "scale-95");
                }
            }

            // Update indicators and manage animation
            for (var j = 0; j < indicators.length; j++) {
                var ind = indicators[j] as HTMLElement;
                var fill = ind.querySelector(".indicator-fill") as HTMLElement;

                // Clear any manual interaction state immediately
                ind.classList.remove("paused");

                if (j === activeIndex) {
                    // Force reflow to restart animation
                    ind.classList.remove("active");
                    if (fill) {
                        fill.style.animation = "none";
                        ind.offsetHeight; /* trigger reflow */
                        fill.style.animation = "";
                    }
                    ind.classList.add("active");
                } else {
                    ind.classList.remove("active");
                }
            }

            // Trigger Typewriter
            var activeCard = cards[activeIndex] as HTMLElement;
            var skills = activeCard.getAttribute("data-skills") || "";
            runTypewriter(skills);
        }

        var typewriterId = 0;

        function runTypewriter(text: string) {
            typewriterId++;
            var currentRunId = typewriterId;

            if (!typewriterElement) return;

            typewriterElement.textContent = "";

            var skillsArray = text.split(", ");
            var displayText = "";
            var totalChars = 0;

            for (var i = 0; i < skillsArray.length; i++) {
                if (i > 0) displayText += " â€¢ ";
                displayText += skillsArray[i];
            }

            function typeNextChar() {
                if (currentRunId !== typewriterId) return;

                if (totalChars < displayText.length) {
                    if (typewriterElement) {
                        typewriterElement.textContent = displayText.slice(
                            0,
                            totalChars + 1,
                        );
                    }
                    totalChars++;
                    setTimeout(typeNextChar, 30);
                }
            }

            setTimeout(function () {
                if (currentRunId !== typewriterId) return;
                typeNextChar();
            }, 100);
        }

        // --- Navigation ---
        function scrollToCard(index: number) {
            console.log("[RolesCarousel] Scrolling to card:", index);
            if (!carousel) return;
            var targetCard = cards[index] as HTMLElement;
            if (!targetCard) return;

            var scrollOffset = targetCard.offsetLeft - carousel.offsetLeft;

            carousel.scrollTo({
                left: scrollOffset,
                behavior: "smooth",
            });
        }

        function handleAutoAdvanceNext() {
            if (document.hidden) return;
            var nextIndex = (activeIndex + 1) % cards.length;
            scrollToCard(nextIndex);
        }

        // --- Event Listeners ---
        if (carousel) {
            carousel.addEventListener(
                "scroll",
                function () {
                    // Debounce usage of updateActiveFromScroll could be nice,
                    // but immediate feedback is better for active state.
                    updateActiveFromScroll();
                },
                { passive: true },
            );
        }

        // Click handlers for cards
        for (var k = 0; k < cards.length; k++) {
            (function (index: number) {
                var card = cards[index] as HTMLElement;
                card.addEventListener("click", function (e: MouseEvent) {
                    e.preventDefault();
                    console.log("[RolesCarousel] Card clicked:", index);
                    // Just scroll. No pause.
                    scrollToCard(index);
                });
            })(k);
        }

        // Click handlers for indicators
        for (var m = 0; m < indicators.length; m++) {
            (function (index: number) {
                var indicator = indicators[index] as HTMLElement;
                indicator.addEventListener("click", function (e: MouseEvent) {
                    e.preventDefault();
                    console.log("[RolesCarousel] Indicator clicked:", index);
                    // Just scroll. No pause.
                    scrollToCard(index);
                });

                var fill = indicator.querySelector(
                    ".indicator-fill",
                ) as HTMLElement;
                if (fill) {
                    fill.addEventListener(
                        "animationend",
                        function (e: AnimationEvent) {
                            e.stopPropagation();
                            // Simple check: if this is the active one finishing, go next.
                            // No user interaction checks.
                            if (index === activeIndex) {
                                console.log(
                                    "[RolesCarousel] Animation complete. Advancing.",
                                );
                                handleAutoAdvanceNext();
                            }
                        },
                    );
                }
            })(m);
        }

        var backToStartBtn = document.getElementById(
            "back-to-start",
        ) as HTMLElement;
        if (backToStartBtn) {
            backToStartBtn.addEventListener("click", function (e: MouseEvent) {
                e.preventDefault();
                console.log("[RolesCarousel] Back to start clicked");
                scrollToCard(0);
            });
        }

        // Initialize
        updateActiveFromScroll();
        console.log("[RolesCarousel] Initialization complete");
    });
</script>

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    #roles-carousel {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
    }

    .role-card {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
    }

    .indicator {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
    }

    /* Animation Styles */
    .indicator.active {
        width: 6rem;
    }

    .indicator.active .indicator-fill {
        animation: fillProgress 5s linear forwards;
    }

    /* No paused style needed anymore */

    @keyframes fillProgress {
        0% {
            width: 0%;
        }
        100% {
            width: 100%;
        }
    }
</style>
