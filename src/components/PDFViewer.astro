---
import Section from "./Section.astro";
import Card from "./ui/Card.astro";
import Button from "./ui/Button.astro";

/* 
  Since we are avoiding React, we'll implement PDF.js control logic in Vanilla JS.
  We'll use a CDN for PDF.js to avoid bundling it in the main chunk, 
  and load it only when this component becomes visible (Manual Islands pattern).
*/
---

<Section id="research" class="py-24">
    <div class="max-w-6xl mx-auto px-8">
        <h2 class="font-display text-4xl font-bold mb-16 tracking-tight">
            Publications & Research
        </h2>

        <div
            class="grid grid-cols-1 lg:grid-cols-[1.5fr_1fr] gap-12 items-start"
        >
            <div class="glass-card p-10 bg-bg-secondary/40">
                <div class="flex items-start justify-between mb-8 gap-4">
                    <div>
                        <h3 class="font-display text-2xl font-bold mb-2">
                            Subtrajectory Clustering with ML on QC
                        </h3>
                        <p
                            class="text-accent-primary font-mono text-xs uppercase tracking-widest"
                        >
                            SSTDM25 - Short Paper (Camera Ready)
                        </p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8 mb-10">
                    <div>
                        <h4
                            class="text-sm font-bold text-text-primary uppercase tracking-wider mb-4 border-b border-white/10 pb-2"
                        >
                            Key Contributions
                        </h4>
                        <ul
                            class="space-y-3 text-sm text-text-secondary list-none"
                        >
                            <li class="flex items-start gap-3">
                                <span class="text-accent-tertiary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><polyline points="20 6 9 17 4 12"
                                        ></polyline></svg
                                    >
                                </span>
                                Integrated Quantum Machine Learning kernels into traditional
                                clustering workflows.
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent-tertiary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><polyline points="20 6 9 17 4 12"
                                        ></polyline></svg
                                    >
                                </span>
                                Developed a novel distance metric for high-dimensional
                                subtrajectory similarity.
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent-tertiary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><polyline points="20 6 9 17 4 12"
                                        ></polyline></svg
                                    >
                                </span>
                                Optimized tensor network contractions, achieving 40%
                                speedup in simulation.
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h4
                            class="text-sm font-bold text-text-primary uppercase tracking-wider mb-4 border-b border-white/10 pb-2"
                        >
                            My Role
                        </h4>
                        <ul
                            class="space-y-3 text-sm text-text-secondary list-none"
                        >
                            <li class="flex items-start gap-3">
                                <span class="text-accent-primary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><circle cx="12" cy="12" r="10"
                                        ></circle><polyline
                                            points="12 6 12 12 16 14"
                                        ></polyline></svg
                                    >
                                </span>
                                Lead developer for the open-source implementation
                                in Python & Qiskit.
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent-primary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><circle cx="12" cy="12" r="10"
                                        ></circle><polyline
                                            points="12 6 12 12 16 14"
                                        ></polyline></svg
                                    >
                                </span>
                                Designed and executed large-scale benchmaring across
                                4 synthetic datasets.
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent-primary mt-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><circle cx="12" cy="12" r="10"
                                        ></circle><polyline
                                            points="12 6 12 12 16 14"
                                        ></polyline></svg
                                    >
                                </span>
                                Authored the methodologies and results sections for
                                the final manuscript.
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <Button
                        href="/paper.pdf"
                        download
                        size="sm"
                        class="bg-accent-primary hover:bg-accent-primary/80"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="mr-2"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                            ></path><polyline points="7 10 12 15 17 10"
                            ></polyline><line x1="12" x2="12" y1="15" y2="3"
                            ></line></svg
                        >
                        Download PDF
                    </Button>
                </div>
            </div>

            <!-- PDF Viewer Sidebar / Preview -->
            <div
                class="glass-card p-6 bg-bg-secondary/20 border-dashed border-white/10"
                id="pdf-viewer-root"
            >
                <div class="pdf-wrapper relative group" id="pdf-wrapper">
                    <!-- Loading State -->
                    <div
                        class="canvas-container bg-black rounded-lg overflow-hidden relative min-h-[400px]"
                    >
                        <canvas id="pdf-canvas" class="w-full h-auto"></canvas>
                        <div
                            class="loading-overlay absolute inset-0 flex flex-col items-center justify-center bg-bg-secondary/80 backdrop-blur-md"
                            id="loading-overlay"
                        >
                            <div
                                class="w-10 h-10 border-2 border-accent-primary border-t-transparent rounded-full animate-spin mb-4"
                            >
                            </div>
                            <p
                                class="text-xs uppercase tracking-widest text-text-secondary"
                            >
                                Loading PDF Preview
                            </p>
                        </div>
                    </div>

                    <!-- Compact Controls -->
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex gap-2">
                            <button
                                class="p-2 glass-card hover:bg-white/10 disabled:opacity-30"
                                id="prev-page"
                                disabled
                                aria-label="Prev"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    ><path d="m15 18-6-6 6-6"></path></svg
                                >
                            </button>
                            <span class="text-xs font-mono self-center px-2"
                                ><span id="page-num">1</span>/<span
                                    id="page-count">--</span
                                ></span
                            >
                            <button
                                class="p-2 glass-card hover:bg-white/10 disabled:opacity-30"
                                id="next-page"
                                disabled
                                aria-label="Next"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    ><path d="m9 18 6-6-6-6"></path></svg
                                >
                            </button>
                        </div>
                        <button
                            class="p-2 glass-card hover:bg-white/10"
                            id="toggle-fullscreen"
                            aria-label="Fullscreen"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                ><path d="M8 3H5a2 2 0 0 0-2 2v3"></path><path
                                    d="M21 8V5a2 2 0 0 0-2-2h-3"></path><path
                                    d="M3 16v3a2 2 0 0 0 2 2h3"></path><path
                                    d="M16 21h3a2 2 0 0 0 2-2v-3"></path></svg
                            >
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Section>

<script>
    // We only load PDF.js when the component is in view
    let pdfDoc: any = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending: number | null = null;
    let scale = 1.0;
    let pdfjsLib: any = null;
    const canvas = document.getElementById("pdf-canvas") as HTMLCanvasElement;
    const ctx = canvas?.getContext("2d");

    const elements = {
        prev: document.getElementById("prev-page") as HTMLButtonElement,
        next: document.getElementById("next-page") as HTMLButtonElement,
        pageNum: document.getElementById("page-num"),
        pageCount: document.getElementById("page-count"),
        loading: document.getElementById("loading-overlay"),
        error: document.getElementById("error-overlay"),
        wrapper: document.getElementById("pdf-wrapper"),
        fullscreenBtn: document.getElementById("toggle-fullscreen"),
    };

    let resizeTimeout: ReturnType<typeof setTimeout> | null = null;

    function renderPage(num: number) {
        if (!pdfDoc || !ctx || !canvas || !elements.wrapper) return;
        pageRendering = true;

        pdfDoc
            .getPage(num)
            .then(function (page: any) {
                // 1. Calculate how much we need to scale the PDF to fit the container width
                const wrapperWidth = elements.wrapper.clientWidth - 48; // Account for padding
                const unscaledViewport = page.getViewport({ scale: 1 });
                const fitScale = Math.min(
                    wrapperWidth / unscaledViewport.width,
                    1.5,
                );

                // 2. Account for device pixel ratio (Retina screens)
                // We scale the viewport itself, not just the canvas, for better text hinting
                const dpr = window.devicePixelRatio || 1;
                const viewport = page.getViewport({ scale: fitScale * dpr });

                // 3. Set canvas dimensions to the high-res size
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // 4. No need to set style.width/height manually if we use w-full h-auto in CSS.
                // But we can ensure it doesn't overflow
                canvas.style.width = "100%";
                canvas.style.height = "auto";

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                    // No transform needed if we scale the viewport directly
                };

                const renderTask = page.render(renderContext);

                renderTask.promise.then(function () {
                    pageRendering = false;
                    elements.loading?.classList.add("hidden");

                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            })
            .catch((err: any) => {
                console.error(err);
                elements.loading?.classList.add("hidden");
                elements.error?.classList.remove("hidden");
            });

        if (elements.pageNum) elements.pageNum.textContent = num.toString();

        if (elements.prev) elements.prev.disabled = num <= 1;
        if (elements.next) elements.next.disabled = num >= pdfDoc.numPages;
    }

    function queueRenderPage(num: number) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    // Handle Window Resize
    window.addEventListener("resize", () => {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (pdfDoc) renderPage(pageNum);
        }, 200);
    });

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    /* Lazy Load Logic */
    const loadPDF = async () => {
        try {
            if (!(window as any).pdfjsLib) {
                const script = document.createElement("script");
                script.src =
                    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs";
                script.type = "module";
                document.head.appendChild(script);

                await new Promise<void>((resolve) => {
                    script.onload = () => resolve();
                    const check = setInterval(() => {
                        if ((window as any).pdfjsLib) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                });
            }

            pdfjsLib = (window as any).pdfjsLib;
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs";

            const loadingTask = pdfjsLib.getDocument("/paper.pdf");
            pdfDoc = await loadingTask.promise;

            if (elements.pageCount)
                elements.pageCount.textContent = pdfDoc.numPages;
            if (elements.next) elements.next.disabled = false;

            renderPage(pageNum);
        } catch (error) {
            console.error("Error loading PDF:", error);
            elements.loading?.classList.add("hidden");
            elements.error?.classList.remove("hidden");
        }
    };

    const root = document.getElementById("pdf-viewer-root");
    if (root) {
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        loadPDF();
                        observer.unobserve(entry.target);
                    }
                });
            },
            { rootMargin: "200px" },
        );
        observer.observe(root);
    }

    elements.prev?.addEventListener("click", onPrevPage);
    elements.next?.addEventListener("click", onNextPage);

    elements.fullscreenBtn?.addEventListener("click", () => {
        const wrapper = elements.wrapper;
        if (!wrapper) return;
        if (!document.fullscreenElement) {
            wrapper.requestFullscreen().catch((err) => {
                console.log(`Error: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    });
</script>

<style>
    .pdf-container {
        padding: var(--space-16) var(--space-8);
        max-width: 1000px;
        margin: 0 auto;
        margin-bottom: var(--space-16);
    }

    h2 {
        font-size: 2.5rem;
        margin-bottom: var(--space-8);
        font-family: var(--font-display);
    }

    .viewer-card {
        padding: var(--space-8);
        background: var(--bg-secondary);
    }

    .background-glow {
        position: absolute;
        top: -50%;
        right: -20%;
        width: 500px;
        height: 500px;
        background: radial-gradient(
            circle,
            rgba(20, 184, 166, 0.1) 0%,
            transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
    }

    .paper-title {
        margin-bottom: var(--space-4);
        font-size: 1.2rem;
        position: relative;
    }

    .description {
        color: var(--text-secondary);
        margin-bottom: var(--space-6);
        position: relative;
    }

    .pdf-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 500px;
    }

    .pdf-wrapper.fullscreen {
        background: var(--bg-primary);
        padding: var(--space-8);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-4);
        background: rgba(10, 10, 15, 0.9);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        flex-wrap: wrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
    }

    .control-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .control-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .control-btn:hover:not(:disabled) {
        background: rgba(99, 102, 241, 0.3);
        border-color: var(--accent-primary);
    }

    .divider {
        width: 1px;
        height: 28px;
        background: rgba(255, 255, 255, 0.15);
        margin: 0 var(--space-1);
    }

    .page-info {
        padding: 0 var(--space-4);
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .zoom-info {
        padding: 0.5rem 1rem;
        background: rgba(99, 102, 241, 0.15);
        border-radius: 0.5rem;
        color: var(--accent-primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
    }

    .canvas-container {
        flex: 1;
        background: #1a1a2e;
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
        min-height: 500px;
        position: relative;
    }

    #pdf-canvas {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border-radius: 4px;
        max-width: 100%;
    }

    .loading-overlay,
    .error-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #1a1a2e;
        z-index: 5;
    }

    .hidden {
        display: none !important;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: var(--space-4);
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .download-section {
        margin-top: var(--space-6);
        display: flex;
        justify-content: flex-end;
    }
</style>
