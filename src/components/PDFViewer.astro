---
import Section from "./Section.astro";
import Card from "./ui/Card.astro";
import Button from "./ui/Button.astro";

/* 
  Since we are avoiding React, we'll implement PDF.js control logic in Vanilla JS.
  We'll use a CDN for PDF.js to avoid bundling it in the main chunk, 
  and load it only when this component becomes visible (Manual Islands pattern).
*/
---

<Section id="research">
    <div class="pdf-container">
        <h2>Publications</h2>
        <Card class="viewer-card" id="pdf-viewer-root">
            <div class="background-glow"></div>

            <h3 class="paper-title">Subtrajectory Clustering with ML on QC</h3>
            <p class="description">
                SSTDM25 - Short Paper (Camera Ready). Exploring novel approaches
                to subtrajectory clustering using quantum machine learning
                techniques.
            </p>

            <div class="pdf-wrapper" id="pdf-wrapper">
                <div class="controls">
                    <button
                        class="control-btn"
                        id="prev-page"
                        disabled
                        aria-label="Previous Page"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="m15 18-6-6 6-6"></path></svg
                        >
                    </button>
                    <div class="page-info">
                        <span id="page-num">1</span> / <span id="page-count"
                            >--</span
                        >
                    </div>
                    <button
                        class="control-btn"
                        id="next-page"
                        disabled
                        aria-label="Next Page"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="m9 18 6-6-6-6"></path></svg
                        >
                    </button>

                    <div class="divider"></div>

                    <button
                        class="control-btn"
                        id="zoom-out"
                        disabled
                        aria-label="Zoom Out"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><circle cx="11" cy="11" r="8"></circle><line
                                x1="21"
                                x2="16.65"
                                y1="21"
                                y2="16.65"></line><line
                                x1="8"
                                x2="14"
                                y1="11"
                                y2="11"></line></svg
                        >
                    </button>
                    <button class="zoom-info" id="reset-zoom" title="Reset Zoom"
                        >100%</button
                    >
                    <button
                        class="control-btn"
                        id="zoom-in"
                        disabled
                        aria-label="Zoom In"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><circle cx="11" cy="11" r="8"></circle><line
                                x1="21"
                                x2="16.65"
                                y1="21"
                                y2="16.65"></line><line
                                x1="11"
                                x2="11"
                                y1="8"
                                y2="14"></line><line
                                x1="8"
                                x2="14"
                                y1="11"
                                y2="11"></line></svg
                        >
                    </button>

                    <div class="divider"></div>

                    <button
                        class="control-btn"
                        id="toggle-fullscreen"
                        aria-label="Fullscreen"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M8 3H5a2 2 0 0 0-2 2v3"></path><path
                                d="M21 8V5a2 2 0 0 0-2-2h-3"></path><path
                                d="M3 16v3a2 2 0 0 0 2 2h3"></path><path
                                d="M16 21h3a2 2 0 0 0 2-2v-3"></path></svg
                        >
                    </button>
                </div>

                <div class="canvas-container">
                    <canvas id="pdf-canvas"></canvas>
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="spinner"></div>
                        <p>Loading PDF...</p>
                    </div>
                    <div class="error-overlay hidden" id="error-overlay">
                        <p>Failed to load PDF</p>
                        <Button
                            href="/paper.pdf"
                            download
                            size="sm"
                            variant="secondary">Download Instead</Button
                        >
                    </div>
                </div>
            </div>

            <div class="download-section">
                <Button href="/paper.pdf" download size="sm">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path><polyline points="7 10 12 15 17 10"
                        ></polyline><line x1="12" x2="12" y1="15" y2="3"
                        ></line></svg
                    >
                    Download PDF
                </Button>
            </div>
        </Card>
    </div>
</Section>

<script>
    // We only load PDF.js when the component is in view
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;
    let pdfjsLib = null;
    const canvas = document.getElementById("pdf-canvas");
    const ctx = canvas.getContext("2d");

    const elements = {
        prev: document.getElementById("prev-page"),
        next: document.getElementById("next-page"),
        zoomIn: document.getElementById("zoom-in"),
        zoomOut: document.getElementById("zoom-out"),
        resetZoom: document.getElementById("reset-zoom"),
        pageNum: document.getElementById("page-num"),
        pageCount: document.getElementById("page-count"),
        loading: document.getElementById("loading-overlay"),
        error: document.getElementById("error-overlay"),
        wrapper: document.getElementById("pdf-wrapper"),
        fullscreenBtn: document.getElementById("toggle-fullscreen"),
    };

    function renderPage(num) {
        pageRendering = true;

        pdfDoc
            .getPage(num)
            .then(function (page) {
                // Responsive scale adjustment: fit width
                const updateScale = () => {
                    const wrapperWidth = elements.wrapper.clientWidth - 48; // padding
                    const unscaledViewport = page.getViewport({ scale: 1 });
                    const fitScale = Math.min(
                        wrapperWidth / unscaledViewport.width,
                        1.5,
                    ); // Cap max default
                    return fitScale * scale;
                };

                const currentViewport = page.getViewport({
                    scale: updateScale(),
                });
                canvas.height = currentViewport.height;
                canvas.width = currentViewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: currentViewport,
                };

                const renderTask = page.render(renderContext);

                renderTask.promise.then(function () {
                    pageRendering = false;
                    elements.loading.classList.add("hidden");

                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            })
            .catch((err) => {
                console.error(err);
                elements.loading.classList.add("hidden");
                elements.error.classList.remove("hidden");
            });

        elements.pageNum.textContent = num;

        // Update button states
        elements.prev.disabled = num <= 1;
        elements.next.disabled = num >= pdfDoc.numPages;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function onZoomIn() {
        if (scale >= 3.0) return;
        scale += 0.25;
        elements.resetZoom.textContent = Math.round(scale * 100) + "%";
        elements.zoomIn.disabled = scale >= 3.0;
        elements.zoomOut.disabled = false;
        queueRenderPage(pageNum);
    }

    function onZoomOut() {
        if (scale <= 0.5) return;
        scale -= 0.25;
        elements.resetZoom.textContent = Math.round(scale * 100) + "%";
        elements.zoomOut.disabled = scale <= 0.5;
        elements.zoomIn.disabled = false;
        queueRenderPage(pageNum);
    }

    function onResetZoom() {
        scale = 1.0;
        elements.resetZoom.textContent = "100%";
        elements.zoomOut.disabled = false;
        elements.zoomIn.disabled = false;
        queueRenderPage(pageNum);
    }

    /* Lazy Load Logic */
    const loadPDF = async () => {
        try {
            // Load PDF.js from CDN
            if (!window.pdfjsLib) {
                const script = document.createElement("script");
                script.src =
                    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs";
                script.type = "module";
                document.head.appendChild(script);

                // Wait for it to load
                await new Promise((resolve) => {
                    script.onload = resolve;
                    // Check periodically if module loaded (since module scripts don't always fire onload same way)
                    const check = setInterval(() => {
                        if (window.pdfjsLib) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                });
            }

            pdfjsLib = window.pdfjsLib;
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs";

            const loadingTask = pdfjsLib.getDocument("/paper.pdf");
            pdfDoc = await loadingTask.promise;

            elements.pageCount.textContent = pdfDoc.numPages;
            elements.next.disabled = false;
            elements.zoomIn.disabled = false;
            elements.zoomOut.disabled = false;

            renderPage(pageNum);
        } catch (error) {
            console.error("Error loading PDF:", error);
            elements.loading.classList.add("hidden");
            elements.error.classList.remove("hidden");
        }
    };

    // Intersection Observer to lazy load
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    loadPDF();
                    observer.unobserve(entry.target);
                }
            });
        },
        { rootMargin: "200px" },
    );

    observer.observe(document.getElementById("pdf-viewer-root"));

    // Event Listeners
    elements.prev.addEventListener("click", onPrevPage);
    elements.next.addEventListener("click", onNextPage);
    elements.zoomIn.addEventListener("click", onZoomIn);
    elements.zoomOut.addEventListener("click", onZoomOut);
    elements.resetZoom.addEventListener("click", onResetZoom);

    // Fullscreen logic
    elements.fullscreenBtn.addEventListener("click", () => {
        const wrapper = elements.wrapper;
        if (!document.fullscreenElement) {
            wrapper.requestFullscreen().catch((err) => {
                console.log(
                    `Error attempting to enable fullscreen: ${err.message}`,
                );
            });
            wrapper.classList.add("fullscreen");
        } else {
            document.exitFullscreen();
            wrapper.classList.remove("fullscreen");
        }
    });
</script>

<style>
    .pdf-container {
        padding: var(--space-16) var(--space-8);
        max-width: 1000px;
        margin: 0 auto;
        margin-bottom: var(--space-16);
    }

    h2 {
        font-size: 2.5rem;
        margin-bottom: var(--space-8);
        font-family: var(--font-display);
    }

    .viewer-card {
        padding: var(--space-8);
        background: var(--bg-secondary);
    }

    .background-glow {
        position: absolute;
        top: -50%;
        right: -20%;
        width: 500px;
        height: 500px;
        background: radial-gradient(
            circle,
            rgba(20, 184, 166, 0.1) 0%,
            transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
    }

    .paper-title {
        margin-bottom: var(--space-4);
        font-size: 1.2rem;
        position: relative;
    }

    .description {
        color: var(--text-secondary);
        margin-bottom: var(--space-6);
        position: relative;
    }

    .pdf-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 500px;
    }

    .pdf-wrapper.fullscreen {
        background: var(--bg-primary);
        padding: var(--space-8);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-4);
        background: rgba(10, 10, 15, 0.9);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        flex-wrap: wrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
    }

    .control-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .control-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .control-btn:hover:not(:disabled) {
        background: rgba(99, 102, 241, 0.3);
        border-color: var(--accent-primary);
    }

    .divider {
        width: 1px;
        height: 28px;
        background: rgba(255, 255, 255, 0.15);
        margin: 0 var(--space-1);
    }

    .page-info {
        padding: 0 var(--space-4);
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .zoom-info {
        padding: 0.5rem 1rem;
        background: rgba(99, 102, 241, 0.15);
        border-radius: 0.5rem;
        color: var(--accent-primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
    }

    .canvas-container {
        flex: 1;
        background: #1a1a2e;
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
        min-height: 500px;
        position: relative;
    }

    #pdf-canvas {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border-radius: 4px;
        max-width: 100%;
    }

    .loading-overlay,
    .error-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #1a1a2e;
        z-index: 5;
    }

    .hidden {
        display: none !important;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: var(--space-4);
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .download-section {
        margin-top: var(--space-6);
        display: flex;
        justify-content: flex-end;
    }
</style>
