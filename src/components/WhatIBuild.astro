---
import Section from "./Section.astro";
---

<Section
    id="what-i-build"
    class="pt-20 pb-8 md:pt-24 md:pb-12 flex flex-col items-center justify-center overflow-hidden"
>
    <div class="max-w-5xl mx-auto px-8 w-full flex flex-col">
        <!-- Navigation Controls (above text, always same position) -->
        <div class="flex items-center justify-center gap-3 mb-6">
            <button
                id="wib-prev"
                class="p-2 text-white/40 hover:text-white/80 transition-colors"
                aria-label="Previous statement"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="m15 18-6-6 6-6"></path></svg
                >
            </button>
            <button
                id="wib-pause"
                class="p-2 text-white/40 hover:text-white/80 transition-colors"
                aria-label="Pause auto-play"
            >
                <svg
                    id="wib-pause-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><rect x="6" y="4" width="4" height="16"></rect><rect
                        x="14"
                        y="4"
                        width="4"
                        height="16"></rect></svg
                >
                <svg
                    id="wib-play-icon"
                    class="hidden"
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><polygon points="5 3 19 12 5 21 5 3"></polygon></svg
                >
            </button>
            <button
                id="wib-next"
                class="p-2 text-white/40 hover:text-white/80 transition-colors"
                aria-label="Next statement"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
                >
            </button>
        </div>

        <!-- Dynamic Headline (fixed height to prevent layout shift) -->
        <div
            class="h-[460px] sm:h-[350px] md:h-[320px] lg:h-[280px] overflow-hidden"
        >
            <p
                class="font-display text-xl sm:text-2xl md:text-2xl lg:text-3xl font-bold tracking-tight leading-loose md:leading-relaxed"
            >
                Delivered <span
                    id="dynamic-outcome"
                    class="inline transition-all duration-500 opacity-0"></span> for
                <span
                    id="dynamic-who"
                    class="inline transition-all duration-500 opacity-0"></span> by
                building <span
                    id="dynamic-product"
                    class="inline transition-all duration-500 opacity-0"></span> that
                <span
                    id="dynamic-proof"
                    class="inline transition-all duration-500 opacity-0"
                ></span>. Built with <span
                    id="dynamic-stack"
                    class="inline transition-all duration-500 opacity-0"
                ></span>.
            </p>
        </div>
    </div>
</Section>

<script>
    const statements = [
        // === ACTIVE: These correspond to actual portfolio projects ===
        {
            outcome: "3× higher automated decision throughput",
            who: "fintech risk pipelines",
            product: "a cascade inference architecture",
            proof: "reduced manual review volume 68% through confidence-based triage while maintaining >96% recall on high-risk outcomes",
            stack: "Python, XGBoost, scikit-learn, and 1.3M Lending Club loan records (Kaggle)",
        },
        {
            outcome: "reduced security risk",
            who: "internal services",
            product: "a security-aware API",
            proof: "enforces least-privilege authorization, strict input validation, abuse-aware rate limiting, and forensic-grade logging",
            stack: "Python, FastAPI, OAuth2/JWT, and Pydantic",
        },
        {
            outcome: "fail-closed security incident normalization",
            who: "internal security teams",
            product: "a deterministic-first extraction pipeline",
            proof: "enforces strict JSON schema validation and bounded recovery on untrusted LLM outputs",
            stack: "Python, Pydantic v2, regex, pytest, and OpenAI Structured Outputs",
        },
        {
            outcome: "lower business risk for high-impact decision systems",
            who: "credit underwriting",
            product: "a cost-sensitive classification pipeline",
            proof: "optimized asymmetric error loss via threshold policy rather than model complexity, reducing high-cost false negatives by 32% with bounded precision trade-offs",
            stack: "Python, pandas, scikit-learn, and Lending Club loan records (Kaggle)",
        },
        {
            outcome: "18.5% lower high-load p95 latency",
            who: "backend services",
            product:
                "a controlled benchmark comparing synchronous vs async+Redis architectures",
            proof: "documented thresholds where caching justified added operational risk",
            stack: "Python, FastAPI, Redis, httpx, Locust, and Matplotlib",
        },
        {
            outcome: "sub-millisecond decision overhead",
            who: "multi-tenant APIs",
            product: "a distributed sliding-window limiter",
            proof: "maintained 0.27ms p99 added latency at 10k QPS with no over-admissions under adversarial single-key flood",
            stack: "Go, Redis (Lua), Ristretto, Prometheus, and vegeta",
        },
        {
            outcome:
                "an offline-estimated 2.8% reduction in expected chargeback loss (95% CI: 0.9–4.5%)",
            who: "payment transactions",
            product: "a cost-sensitive fraud risk scoring pipeline",
            proof: "enforced an FPR ≤ 2% constraint via threshold optimization and achieved 23.8% precision at a 0.37% decline rate",
            stack: "XGBoost, Python, and Snowflake",
        },
        // === COMMENTED OUT: Projects not yet built ===
        // {
        //     outcome: "higher adoption completion",
        //     who: "new SaaS users",
        //     product: "a self-serve onboarding flow",
        //     proof: "raised activation to 48% in the first 30 days",
        //     stack: "Next.js, TypeScript, Postgres, and Segment",
        // },
        // {
        //     outcome: "faster release cycles",
        //     who: "a small product team",
        //     product: "a CI/CD pipeline",
        //     proof: "cut deploy time from 35 minutes to 7 minutes",
        //     stack: "GitHub Actions, Docker, and Terraform",
        // },
        // {
        //     outcome: "lower cloud spend",
        //     who: "a bootstrapped app",
        //     product: "a serverless ingestion workflow",
        //     proof: "reduced compute costs by 33% month-over-month",
        //     stack: "AWS Lambda, S3, and Step Functions",
        // },
        // {
        //     outcome: "lower p95 latency",
        //     who: "API consumers",
        //     product: "a caching + query optimization layer",
        //     proof: "reduced p95 from 420ms to 140ms",
        //     stack: "Redis, Postgres, and FastAPI",
        // },
        // {
        //     outcome: "higher conversion",
        //     who: "an e-commerce catalog",
        //     product: "a faceted search + relevance tuning pipeline",
        //     proof: "improved search-to-cart by 9%",
        //     stack: "Elasticsearch, Next.js, and TypeScript",
        // },
        // {
        //     outcome: "more reliable analytics",
        //     who: "operators and stakeholders",
        //     product: "an event-driven ingestion pipeline",
        //     proof: "cut data freshness lag from 45 minutes to under 2 minutes",
        //     stack: "Kafka, Go, and Kubernetes",
        // },
        // {
        //     outcome: "reduced support load",
        //     who: "a B2B product",
        //     product: "a self-serve admin console",
        //     proof: "reduced tickets per active customer by 28%",
        //     stack: "React, Node.js, and Postgres",
        // },
        // {
        //     outcome: "higher email engagement",
        //     who: "a newsletter operator",
        //     product: "a segmentation + send-time optimizer",
        //     proof: "increased CTR by 14% over 6 weeks",
        //     stack: "Python, Airflow, and BigQuery",
        // },
        // {
        //     outcome: "fewer payment failures",
        //     who: "subscription customers",
        //     product: "a payment retry + dunning system",
        //     proof: "reduced involuntary churn by 11%",
        //     stack: "Stripe, Webhooks, and PostgreSQL",
        // },
        // {
        //     outcome: "faster incident response",
        //     who: "an on-call rotation",
        //     product: "observability dashboards + alerting",
        //     proof: "reduced MTTR by 41%",
        //     stack: "Prometheus, Grafana, and OpenTelemetry",
        // },
        // {
        //     outcome: "higher match quality",
        //     who: "volunteers",
        //     product: "a recommendation service",
        //     proof: "improved offline NDCG@10 by +0.08 on historical interactions",
        //     stack: "Python, PyTorch, and AWS",
        // },
        // {
        //     outcome: "fewer fraud losses",
        //     who: "a marketplace",
        //     product: "a risk scoring model",
        //     proof: "reduced chargebacks by 19% while holding false positives under 2%",
        //     stack: "XGBoost, Python, and Snowflake",
        // },
        // {
        //     outcome: "higher retention",
        //     who: "a consumer app",
        //     product: "a personalized notification policy",
        //     proof: "improved D30 retention by 6%",
        //     stack: "Firebase, Python, and BigQuery",
        // },
        // {
        //     outcome: "safer rollouts",
        //     who: "a production service",
        //     product: "a feature-flagged release system",
        //     proof: "cut rollback incidents by 55%",
        //     stack: "LaunchDarkly, Kubernetes, and Helm",
        // },
        // {
        //     outcome: "faster setup",
        //     who: "new customers",
        //     product: "automated tenant provisioning",
        //     proof: "reduced onboarding from 2 hours of manual work to 8 minutes",
        //     stack: "Terraform, AWS IAM, and Postgres",
        // },
        // {
        //     outcome: "better search relevance",
        //     who: "documentation readers",
        //     product: "a semantic search layer",
        //     proof: 'reduced "no useful result" sessions by 24%',
        //     stack: "pgvector, Postgres, and FastAPI",
        // },
        // {
        //     outcome: "lower infra risk",
        //     who: "a growing microservices stack",
        //     product: "infra-as-code + policy checks",
        //     proof: "prevented drift and standardized 100% of environments",
        //     stack: "Terraform, OPA, and GitHub Actions",
        // },
        // {
        //     outcome: "higher throughput",
        //     who: "a data pipeline",
        //     product: "a batch-to-stream migration",
        //     proof: "increased processing from 3k to 25k events/sec",
        //     stack: "Kafka, Flink, and Kubernetes",
        // },
        // {
        //     outcome: "lower error rates",
        //     who: "API users",
        //     product: "input validation + typed contracts",
        //     proof: "reduced 4xx/5xx by 22%",
        //     stack: "TypeScript, Zod, and Fastify",
        // },
        // {
        //     outcome: "faster analytics iteration",
        //     who: "product stakeholders",
        //     product: "a metrics layer + experiment dashboard",
        //     proof: "reduced time-to-answer from days to minutes",
        //     stack: "dbt, BigQuery, and Looker Studio",
        // },
        // {
        //     outcome: "lower storage costs",
        //     who: "a media-heavy app",
        //     product: "a tiered storage + lifecycle policy",
        //     proof: "reduced storage spend by 46%",
        //     stack: "S3, CloudFront, and Terraform",
        // },
        // {
        //     outcome: "higher signup completion",
        //     who: "mobile users",
        //     product: "a friction-reduced auth flow",
        //     proof: "improved signup completion by 17%",
        //     stack: "SwiftUI, Sign in with Apple, and Firebase",
        // },
        // {
        //     outcome: "more dependable jobs",
        //     who: "nightly operations",
        //     product: "idempotent retries + dead-letter queues",
        //     proof: "achieved 99.9% job success across 1,200 runs",
        //     stack: "SQS, Lambda, and CloudWatch",
        // },
        // {
        //     outcome: "better recommendations",
        //     who: "content discovery",
        //     product: "a two-stage retrieval + ranking stack",
        //     proof: "improved precision@10 by 12% in offline evaluation",
        //     stack: "Faiss, PyTorch, and Python",
        // },
        // {
        //     outcome: "faster page loads",
        //     who: "web users",
        //     product: "edge caching + image optimization",
        //     proof: "cut LCP from 3.2s to 1.4s",
        //     stack: "Next.js, Cloudflare, and WebP",
        // },
        // {
        //     outcome: "stronger security posture",
        //     who: "a SaaS backend",
        //     product: "least-privilege IAM + secrets hygiene",
        //     proof: "eliminated long-lived credentials and passed a third-party review",
        //     stack: "AWS IAM, Secrets Manager, and Terraform",
        // },
        // {
        //     outcome: "higher lead capture",
        //     who: "a marketing funnel",
        //     product: "a quiz + dynamic landing flow",
        //     proof: "increased email opt-in rate by 23%",
        //     stack: "React, Node.js, and PostHog",
        // },
        // {
        //     outcome: "lower operational toil",
        //     who: "developers",
        //     product: "a one-command local dev environment",
        //     proof: "reduced setup time from 90 minutes to 12 minutes",
        //     stack: "Docker Compose, Make, and Dev Containers",
        // },
        // {
        //     outcome: "real-world partner impact",
        //     who: "a local nonprofit",
        //     product: "a volunteer opportunity aggregator + matching tool",
        //     proof: "generated 300 matched signups in its first month",
        //     stack: "Python, FastAPI, and Postgres",
        // },
        // {
        //     outcome: "measurable early traction",
        //     who: "a new product",
        //     product: "an instrumented MVP",
        //     proof: "reached 1,000 weekly active sessions within 6 weeks",
        //     stack: "Next.js, Postgres, and PostHog",
        // },
    ];

    let currentIndex = 0;
    const outcomeEl = document.getElementById("dynamic-outcome");
    const whoEl = document.getElementById("dynamic-who");
    const productEl = document.getElementById("dynamic-product");
    const proofEl = document.getElementById("dynamic-proof");
    const stackEl = document.getElementById("dynamic-stack");

    // Colors from TechTicker
    const colors = [
        "#f472b6", // pink-400
        "#c084fc", // purple-400
        "#22d3ee", // cyan-400
        "#818cf8", // indigo-400
        "#34d399", // emerald-400
        "#e879f9", // fuchsia-400
        "#38bdf8", // sky-400
        "#a78bfa", // violet-400
    ];

    function getRandomColors(count: number) {
        const shuffled = [...colors].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, count);
    }

    // Navigation controls
    const prevBtn = document.getElementById("wib-prev");
    const pauseBtn = document.getElementById("wib-pause");
    const nextBtn = document.getElementById("wib-next");
    const pauseIcon = document.getElementById("wib-pause-icon");
    const playIcon = document.getElementById("wib-play-icon");

    let isPaused = false;
    let intervalId: number | null = null;

    function goToIndex(index: number) {
        currentIndex =
            ((index % statements.length) + statements.length) %
            statements.length;
        updatePhrasing(false); // Don't auto-increment
    }

    function updatePhrasing(autoIncrement = true) {
        if (!outcomeEl || !whoEl || !productEl || !proofEl || !stackEl) return;

        // When auto-playing, advance to next statement BEFORE displaying
        if (autoIncrement) {
            currentIndex = (currentIndex + 1) % statements.length;
        }

        const { outcome, who, product, proof, stack } =
            statements[currentIndex];

        // Animate out (fade)
        outcomeEl.classList.add("opacity-0");
        whoEl.classList.add("opacity-0");
        productEl.classList.add("opacity-0");
        proofEl.classList.add("opacity-0");
        stackEl.classList.add("opacity-0");

        setTimeout(() => {
            // Get 5 random colors
            const [c1, c2, c3, c4, c5] = getRandomColors(5);

            // Update content and colors
            outcomeEl.textContent = outcome;
            outcomeEl.style.color = c1;
            whoEl.textContent = who;
            whoEl.style.color = c2;
            productEl.textContent = product;
            productEl.style.color = c3;
            proofEl.textContent = proof;
            proofEl.style.color = c4;
            stackEl.textContent = stack;
            stackEl.style.color = c5;

            // Reset classes
            outcomeEl.className =
                "inline transition-all duration-500 opacity-0";
            whoEl.className = "inline transition-all duration-500 opacity-0";
            productEl.className =
                "inline transition-all duration-500 opacity-0";
            proofEl.className = "inline transition-all duration-500 opacity-0";
            stackEl.className = "inline transition-all duration-500 opacity-0";

            // Trigger reflow
            outcomeEl.offsetHeight;
            whoEl.offsetHeight;
            productEl.offsetHeight;
            proofEl.offsetHeight;
            stackEl.offsetHeight;

            // Animate in (fade)
            outcomeEl.classList.remove("opacity-0");
            whoEl.classList.remove("opacity-0");
            productEl.classList.remove("opacity-0");
            proofEl.classList.remove("opacity-0");
            stackEl.classList.remove("opacity-0");
        }, 500);
    }

    function startInterval() {
        if (intervalId) clearInterval(intervalId);
        if (
            !window.matchMedia("(prefers-reduced-motion: reduce)").matches &&
            !isPaused
        ) {
            intervalId = setInterval(updatePhrasing, 5000);
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        if (pauseIcon && playIcon) {
            pauseIcon.classList.toggle("hidden", isPaused);
            playIcon.classList.toggle("hidden", !isPaused);
        }
        if (isPaused && intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        } else {
            startInterval();
        }
    }

    // Button handlers
    prevBtn?.addEventListener("click", () => {
        goToIndex(currentIndex - 1);
        startInterval(); // Reset timer after manual nav
    });

    nextBtn?.addEventListener("click", () => {
        goToIndex(currentIndex + 1);
        startInterval(); // Reset timer after manual nav
    });

    pauseBtn?.addEventListener("click", togglePause);

    // Initial run
    updatePhrasing();
    startInterval();
</script>
